<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMPMAIL ULTIMATE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { 
                        brand: { 500: '#687cf7', 600: '#4a57f1' },
                        darkBg: '#050507',
                        darkCard: '#121217'
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass-card { background: rgba(18, 18, 23, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        @keyframes gradient-bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .animate-gradient { background: linear-gradient(-45deg, #6366f1, #a855f7, #ec4899, #3b82f6); background-size: 400% 400%; animation: gradient-bg 15s ease infinite; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkBg text-slate-900 dark:text-zinc-100 transition-colors duration-500 font-sans overflow-hidden h-screen">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-white dark:bg-darkBg flex flex-col items-center justify-center">
        <div class="animate-gradient w-24 h-24 rounded-[2.5rem] flex items-center justify-center shadow-2xl mb-6">
            <span class="material-symbols-rounded text-white text-5xl">mail</span>
        </div>
        <h1 class="text-4xl font-extrabold tracking-tighter bg-clip-text text-transparent animate-gradient">TEMPMAIL</h1>
        <div class="mt-10 w-40 h-1 bg-slate-100 dark:bg-zinc-800 rounded-full overflow-hidden">
            <div id="loader-bar" class="h-full bg-brand-500 w-0 transition-all duration-1000"></div>
        </div>
    </div>

    <!-- Sidebar / History -->
    <div id="sidebar" class="fixed inset-0 z-50 invisible">
        <div id="sidebar-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="toggleSidebar()"></div>
        <div id="sidebar-content" class="absolute left-0 top-0 bottom-0 w-[85%] max-w-sm bg-white dark:bg-darkCard shadow-2xl -translate-x-full transition-transform duration-300 p-6 flex flex-col">
            <div class="flex items-center justify-between mb-8">
                <h3 class="font-extrabold text-2xl">Email History</h3>
                <button onclick="toggleSidebar()" class="p-2 bg-slate-100 dark:bg-zinc-800 rounded-full">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3 no-scrollbar"></div>
            <div class="mt-6">
                <!-- NEW IDENTITY BUTTON FIXED -->
                <button id="btn-new-identity" onclick="createNewAccount()" class="w-full py-4 bg-brand-500 text-white font-bold rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-brand-500/30 active:scale-95 transition-all">
                    <span class="material-symbols-rounded">add_circle</span> New Identity
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="hidden h-screen flex flex-col max-w-md mx-auto relative bg-white dark:bg-darkBg overflow-hidden shadow-2xl">
        
        <header class="px-5 py-4 flex items-center justify-between sticky top-0 z-30 glass-card mx-2 mt-2 rounded-3xl">
            <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-2xl transition-all">
                <span class="material-symbols-rounded">history</span>
            </button>
            <div class="text-center">
                <h2 class="text-xs font-black tracking-[0.2em] text-brand-500 uppercase">Ultimate</h2>
                <h1 class="text-lg font-extrabold">TEMPMAIL</h1>
            </div>
            <button onclick="toggleTheme()" class="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-2xl transition-all">
                <span id="theme-icon" class="material-symbols-rounded">dark_mode</span>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-6 pb-24">
            <!-- Email Card -->
            <div class="bg-white dark:bg-darkCard p-6 rounded-[2.5rem] border border-slate-100 dark:border-zinc-800 shadow-xl overflow-hidden relative group">
                <div class="flex justify-between items-start mb-6">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-black uppercase text-slate-400">Time Remaining</span>
                        <div id="timer-display" class="text-xl font-black text-brand-500 tabular-nums">24:00:00</div>
                    </div>
                    <button onclick="showQR()" class="p-2 bg-slate-50 dark:bg-zinc-800 rounded-xl"><span class="material-symbols-rounded">qr_code_2</span></button>
                </div>
                <h3 id="current-email" class="text-xl font-bold truncate mb-6 select-all">Loading...</h3>
                <div class="flex gap-2">
                    <button onclick="copyToClipboard()" class="flex-[2] bg-brand-500 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-brand-500/20 active:scale-95 transition-all">
                        <span class="material-symbols-rounded">content_copy</span> Copy Mail
                    </button>
                    <button onclick="extendTimer()" class="flex-1 bg-slate-100 dark:bg-zinc-800 py-4 rounded-2xl font-bold flex items-center justify-center active:scale-95 transition-all">
                        <span class="material-symbols-rounded">update</span>
                    </button>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="grid grid-cols-2 gap-3">
                <div class="p-4 rounded-3xl bg-white dark:bg-darkCard border border-slate-100 dark:border-zinc-800 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center"><span class="material-symbols-rounded">inbox</span></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase">Inbox</p><p id="msg-count" class="text-lg font-black">0</p></div>
                </div>
                <div class="p-4 rounded-3xl bg-white dark:bg-darkCard border border-slate-100 dark:border-zinc-800 flex items-center gap-3 cursor-pointer" onclick="checkInbox(true)">
                    <div class="w-10 h-10 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center"><span id="refresh-spin" class="material-symbols-rounded">sync</span></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase">Status</p><p class="text-lg font-black text-green-600">Active</p></div>
                </div>
            </div>

            <!-- Inbox List -->
            <div class="space-y-4">
                <h4 class="text-xl font-extrabold px-1">Recent Messages</h4>
                <div id="inbox-list" class="space-y-3">
                    <div class="text-center py-10 opacity-30"><p class="font-bold">No mail yet</p></div>
                </div>
            </div>
        </main>

        <!-- QR Overlay -->
        <div id="qr-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-6">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="hideQR()"></div>
            <div class="relative bg-white dark:bg-darkCard p-8 rounded-[3rem] text-center slide-up">
                <h3 class="text-xl font-black mb-6">Scan to Copy</h3>
                <div id="qrcode" class="bg-white p-4 rounded-3xl inline-block mb-6"></div>
                <button onclick="hideQR()" class="w-full py-4 bg-slate-100 dark:bg-zinc-800 rounded-2xl font-bold">Close</button>
            </div>
        </div>

        <!-- Message View -->
        <div id="msg-view" class="fixed inset-0 z-[60] bg-white dark:bg-darkBg translate-y-full transition-transform duration-500 flex flex-col">
            <div class="p-4 border-b dark:border-zinc-800 flex items-center justify-between">
                <button onclick="closeMessage()" class="p-2 bg-slate-100 dark:bg-zinc-800 rounded-xl"><span class="material-symbols-rounded">close</span></button>
                <span class="text-xs font-black text-slate-400">EMAIL VIEW</span>
                <div class="w-10"></div>
            </div>
            <div id="msg-body" class="flex-1 overflow-y-auto p-6 no-scrollbar"></div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] hidden">
            <div class="bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 px-8 py-4 rounded-3xl shadow-2xl font-bold flex items-center gap-3 slide-up border border-white/10">
                <span id="toast-text">Success</span>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL FUNCTIONS (Must be outside for onclick to work) ---
        const API = 'https://api.mail.tm';
        const DAY = 86400;
        let state = {
            activeAccount: null,
            accounts: JSON.parse(localStorage.getItem('tm_pro_accounts_v2') || '[]'),
            messages: [],
            timeLeft: DAY
        };

        function showToast(text) {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = text;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        async function createNewAccount() {
            const btn = document.getElementById('btn-new-identity');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin material-symbols-rounded">sync</span> Creating...';

            try {
                const dRes = await fetch(`${API}/domains`);
                const dData = await dRes.json();
                const domain = dData['hydra:member'][0].domain;

                const address = `${Math.random().toString(36).substring(7)}@${domain}`;
                const password = Math.random().toString(36).substring(2, 12);

                const reg = await fetch(`${API}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });

                if (!reg.ok) throw new Error("API Limit Reached");

                const auth = await fetch(`${API}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
                const authData = await auth.json();

                const newAcc = { address, password, token: authData.token, createdAt: Date.now() };
                state.accounts.unshift(newAcc);
                localStorage.setItem('tm_pro_accounts_v2', JSON.stringify(state.accounts));
                
                await switchAccount(address);
                showToast("New Identity Generated!");
                if (!document.getElementById('sidebar').classList.contains('invisible')) toggleSidebar();
                updateHistoryUI();
            } catch (err) {
                showToast("Try again in 1 minute");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-rounded">add_circle</span> New Identity';
            }
        }

        async function switchAccount(address) {
            const acc = state.accounts.find(a => a.address === address);
            if (!acc) return;
            state.activeAccount = acc;
            document.getElementById('current-email').innerText = acc.address;
            state.timeLeft = DAY;
            
            // QR Update
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: acc.address, width: 200, height: 200 });

            // Refresh token
            try {
                const res = await fetch(`${API}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: acc.address, password: acc.password })
                });
                const data = await res.json();
                if (data.token) state.activeAccount.token = data.token;
                checkInbox();
            } catch (e) {}
        }

        async function checkInbox(manual = false) {
            if (!state.activeAccount?.token) return;
            if (manual) document.getElementById('refresh-spin').classList.add('animate-spin');

            try {
                const res = await fetch(`${API}/messages`, {
                    headers: { 'Authorization': `Bearer ${state.activeAccount.token}` }
                });
                const data = await res.json();
                const msgs = data['hydra:member'] || [];
                
                if (msgs.length !== state.messages.length) {
                    state.messages = msgs;
                    document.getElementById('msg-count').innerText = msgs.length;
                    renderInbox();
                    if (!manual && msgs.length > 0) showToast("New Mail Received!");
                }
            } finally {
                if (manual) setTimeout(() => document.getElementById('refresh-spin').classList.remove('animate-spin'), 600);
            }
        }

        function renderInbox() {
            const list = document.getElementById('inbox-list');
            if (state.messages.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-30"><p class="font-bold">Waiting for mail...</p></div>`;
                return;
            }
            list.innerHTML = state.messages.map(m => `
                <div onclick="openMessage('${m.id}')" class="p-5 bg-white dark:bg-darkCard border border-slate-100 dark:border-zinc-800 rounded-[2rem] flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                    <div class="w-12 h-12 rounded-2xl bg-brand-500 text-white flex items-center justify-center font-black text-xl">${m.from.address[0].toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                        <span class="text-xs font-black text-slate-400 uppercase">${m.from.name || 'Sender'}</span>
                        <p class="text-sm font-extrabold truncate">${m.subject || '(No Subject)'}</p>
                    </div>
                </div>
            `).join('');
        }

        async function openMessage(id) {
            const body = document.getElementById('msg-body');
            body.innerHTML = '<div class="flex justify-center py-10 animate-spin"><span class="material-symbols-rounded text-brand-500 text-4xl">sync</span></div>';
            document.getElementById('msg-view').classList.remove('translate-y-full');

            try {
                const res = await fetch(`${API}/messages/${id}`, {
                    headers: { 'Authorization': `Bearer ${state.activeAccount.token}` }
                });
                const msg = await res.json();
                body.innerHTML = `
                    <h2 class="text-2xl font-black mb-4">${msg.subject || '(No Subject)'}</h2>
                    <p class="text-xs font-bold text-slate-400 mb-6">${msg.from.address}</p>
                    <div class="prose dark:prose-invert text-sm">${msg.html ? msg.html[0] : msg.text}</div>
                `;
            } catch (e) {}
        }

        function updateHistoryUI() {
            document.getElementById('history-list').innerHTML = state.accounts.map(acc => `
                <div onclick="switchFromHistory('${acc.address}')" class="p-4 rounded-3xl border ${state.activeAccount?.address === acc.address ? 'border-brand-500 bg-brand-500/5' : 'border-slate-100 dark:border-zinc-800'} cursor-pointer">
                    <p class="text-xs font-black truncate">${acc.address}</p>
                    <p class="text-[9px] text-slate-400 mt-1 uppercase font-bold tracking-widest">${new Date(acc.createdAt).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar');
            const c = document.getElementById('sidebar-content');
            const o = document.getElementById('sidebar-overlay');
            if (s.classList.contains('invisible')) {
                s.classList.remove('invisible');
                setTimeout(() => { o.classList.replace('opacity-0', 'opacity-100'); c.classList.replace('-translate-x-full', 'translate-x-0'); }, 10);
                updateHistoryUI();
            } else {
                o.classList.replace('opacity-100', 'opacity-0');
                c.classList.replace('translate-x-0', '-translate-x-full');
                setTimeout(() => s.classList.add('invisible'), 300);
            }
        }

        function copyToClipboard() {
            const el = document.createElement("textarea");
            el.value = state.activeAccount.address;
            document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            showToast("Email Copied!");
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
        }

        function startApp() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.className = theme;
            document.getElementById('loader-bar').style.width = '100%';

            setTimeout(async () => {
                if (state.accounts.length > 0) await switchAccount(state.accounts[0].address);
                else await createNewAccount();
                
                document.getElementById('splash-screen').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('splash-screen').remove();
                    document.getElementById('app-container').classList.remove('hidden');
                }, 500);
            }, 1200);

            setInterval(() => {
                state.timeLeft--;
                const h = Math.floor(state.timeLeft / 3600);
                const m = Math.floor((state.timeLeft % 3600) / 60);
                const s = state.timeLeft % 60;
                document.getElementById('timer-display').innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);

            setInterval(checkInbox, 10000);
        }

        // Global Bindings
        window.toggleSidebar = toggleSidebar;
        window.createNewAccount = createNewAccount;
        window.switchFromHistory = (addr) => { switchAccount(addr); toggleSidebar(); };
        window.copyToClipboard = copyToClipboard;
        window.extendTimer = () => { state.timeLeft = DAY; showToast("Timer Reset"); };
        window.toggleTheme = toggleTheme;
        window.showQR = () => document.getElementById('qr-modal').classList.remove('hidden');
        window.hideQR = () => document.getElementById('qr-modal').classList.add('hidden');
        window.closeMessage = () => document.getElementById('msg-view').classList.add('translate-y-full');

        startApp();
    </script>
</body>
</html>